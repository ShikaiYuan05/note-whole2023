# 一、心法
- 理论：工作原理、工作机制……从需求来的，学习的时候从需求出发来理解，用“提问”方式来驱动学习。
- 操作：语法层面是人为规定的，是刚性的，遵照设定执行即可。怕忘就维护好资料，用的时候知道去哪找即可。
- 如果说整个知识体系是一个树形结构
	- 我们内心对理论的理解，就构成了这个树形结构的枝干
	- 我们维护的资料，就是树形结构中的叶子

# 二、基础
为了能够参与后续项目中的业务开发，我们至少要掌握“三大件”：
- 注册中心：Nacos
- 声明式远程调用：OpenFeign
- 网关：Gateway

> 程序员成长路径：语法->技术->业务->工程化->性能、健壮性->架构->主流开源框架核心贡献者->计算机科学家->物理学家、数学家->哲学家、神学家……

# 三、理论&优化
## 1、总的脉络
- 单一架构：整个项目没有拆分模块。
- 分布式架构：项目拆分很多模块来开发，模块之间要进行远程调用。
- 分布式架构开发框架：Dubbo、SpringBoot&SpringCloud……
- 微服务之间互相调用：RestTemplate
- 微服务A调用微服务B，为了动态、实时获取B的改动，需要注册中心
	- 微服务B把自己的信息发布到注册中心：服务的注册
	- 微服务A到注册中心拉取其它服务的信息：服务的发现
- 微服务B为了避免单点故障会配置集群，微服务A需要有负载均衡的能力：Ribbon
- 微服务B有可能调用失败，比如：抛异常、超时、响应很慢……，而且故障有可能蔓延到系统中的很大范围甚至导致系统瘫痪（服务雪崩）。为了解决这样的问题：
	- 服务降级：provider、consumer的方法都可以额外提供备选方案，万一发生故障执行备选方案返回兜底值，让调用者拿到兜底值可以继续执行，以免发生雪崩
	- 服务熔断：根据特定的触发条件，打开断路器（circuitBreaker）
		- 关闭：可以正常发送请求
		- 全开：在一段时间内，彻底不允许发送请求，直接调用降级方案
		- 半开：全开状态持续指定时间后，放行一个请求，探测状态恢复
			- 调用成功：断路器关闭
			- 调用失败：断路器全开
- 基于上述功能，如果要自己写代码会非常麻烦，所以框架替我们做了封装：OpenFeign
	- 声明式远程调用：像调本地方法一样调用远程方法
- 当我们整个系统微服务很多时，前端对接不方便而且存在跨域问题，所以SpringCloud提供了整个项目的统一入口：网关（Gateway）
	- 路由：前端请求先到达网关，然后再由网关转发到对应的微服务
	- 过滤：在网关中开发一个过滤器，执行特定的过滤逻辑（例如：登录检查）
	- 负载均衡：网关内部也集成了Ribbon，所以能够对后续微服务做负载均衡
- 微服务日常维护和监控
	- 为了便于管理众多微服务的配置信息，需要使用配置中心，避免重启或重新部署微服务
	- 微服务监控仪表盘：Hystrix dashboard、Alibaba Sentinel都提供了相关功能
	- 链路追踪：查看整个调用过程涉及到哪些微服务
		- Sleuth：在微服务内部收集调用数据发送给Zipkin
		- Zipkin：图形化界面展示链路
	- 流量保护：主要是Alibaba Sentinel提供这方面功能
		- 流控规则
		- 熔断规则
		- 系统规则
		- 热点Key规则
		- ……

## 2、Nacos
- 注册微服务
	- 核心依赖：spring-cloud-starter-alibaba-nacos-discovery
	- 关键注解：@EnableDiscoveryClient
	- 核心配置：spring.cloud.nacos.discovery.server-addr
- 配置中心
	- 概念之间的结构：Namespace>Group>Service>Cluster>instance
	- Data ID结构
- 持久化
	- 内置数据库
	- 配置外部的MySQL
- 集群：必须使用外部数据源，只支持MySQL，以避免数据不一致

## 3、Ribbon
- 客户端负载均衡
- 和Nginx区别
	- Ribbon是正向代理，帮助consumer访问provider；必须依赖SpringCloud环境；本身是个jar包
	- Nginx是反向代理，帮助外网访问内网；本身是Linux系统平台上安装的一个软件
- 负载均衡策略：不管具体哪种策略，第一次访问第一个实例都是随机的
	- 轮询 RoundRobinRule
	- 权重 WeightedResponseTimeRule
	- 随机 RandomRule
	- 最小连接数 BestAvailableRule
	- 重试策略 RetryRule
	- 可用性敏感 AvailabilityFilteringRule
	- 区域敏感 ZoneAvoidanceRule

## 4、OpenFeign
- 理念：声明式远程调用，像调用本地方法一样调用远程方法
- 提供接口：
	- 指定目标微服务名称
	- 指定降级方案类
- 主启动类需要标记@EnableFeignClients注解
- 核心依赖：spring-cloud-starter-openfeign

## 5、Hystrix
- Netflix系列的组件，目前已经停止更新
- 服务降级：provider、consumer的方法都可以额外提供备选方案，万一发生故障执行备选方案返回兜底值，让调用者拿到兜底值可以继续执行，以免发生雪崩
- 服务熔断：根据特定的触发条件，打开断路器（circuitBreaker）
	- 关闭：可以正常发送请求
	- 全开：在一段时间内，彻底不允许发送请求，直接调用降级方案
	- 半开：全开状态持续指定时间后，放行一个请求，探测状态恢复
		- 调用成功：断路器关闭
		- 调用失败：断路器全开
- 监控：仪表盘
- 代码中的关键设置：
	- 核心依赖：spring-cloud-starter-netflix-hystrix
	- 核心注解：
		- @EnableCircuitBreaker标记在Provider端的主启动类上
		- @EnableHystrix标记在Consumer端的主启动类上
		- @HystrixCommand不是写在主启动类，而是有需要的方法
			- fallbackMethod属性：指定降级方法
			- commandProperties属性：指定额外配置的参数
				- 参数execution.isolation.thread.timeoutInMilliseconds：指定当前方法超时时间
				- 参数circuitBreaker.enabled：启用断路器
				- 参数circuitBreaker.requestVolumeThreshold：限定时间内的总请求数
				- 参数circuitBreaker.sleepWindowInMilliseconds：断路器从全开到半开状态中间的时间长度

## 6、网关
- 基本功能
	- 路由：前端请求先到达网关，然后再由网关转发到对应的微服务
	- 过滤：在网关中开发一个过滤器，执行特定的过滤逻辑（例如：登录检查）
	- 负载均衡：网关内部也集成了Ribbon，所以能够对后续微服务做负载均衡
- 代码中的关键设置
	- 核心注解：标记为注册中心的客户端即可
	- 核心依赖：spring-cloud-starter-gateway
	- 路由配置：
		- id：指定当前路由规则的唯一标识
		- predicates：断言匹配规则，匹配上的请求执行路由规则
		- uri：执行路由操作时要前往的微服务
			- 动态路由：lb://微服务名称
			- 静态路径：写死的请求地址
	- 自定义全局过滤器
		- 过滤器类需要加入IOC容器
		- 实现接口：org.springframework.cloud.gateway.filter.GlobalFilter

## 7、链路追踪
在复杂调用过程中，查看服务调用链路：
- Sleuth：在微服务内部收集调用数据发送给Zipkin
- Zipkin：图形化界面展示链路

## 8、Sentinel
- 规则设置
	- 流控规则
		- 资源名称：当前微服务中某个请求地址
		- 阈值类型
			- QPS
			- 并发线程数
		- 流控模式
			- 直接
			- 关联
			- 链路
		- 流控效果
			- 快速失败
			- Warm Up
			- 排队等待
	- 系统规则：针对整个微服务设置参数
	- 熔断规则
		- 触发条件
			-   慢调用比例阈值：同时满足以下两个条件，触发熔断
			    -   在统计时间内，总的请求数量达到我们设定的值
			    -   响应时间超过RT（最大响应时间）的请求的比例超过阈值
			-   异常比例阈值：同时满足以下两个条件，触发熔断
			    -   在统计时间内，总的请求数量达到我们设定的值
			    -   发生异常的请求的比例达到阈值
			-   异常数阈值：在统计时间内异常数量达到阈值，触发熔断
		- 熔断状态
			-   关闭：没有熔断，可以正常请求的状态
			-   全开：执行了熔断，所有请求都不能执行，会持续一段时间
			-   半开：全开持续时间到达后，放行一个请求去执行操作，探测恢复状态
			    -   响应时间正常、没有抛异常：结束熔断状态
			    -   响应时间不正常或抛异常：继续熔断
	- 热点Key规则：针对服务中的指定参数来限制流量
- 降级方案
	- @SentinelResources
		- vlaue属性：资源名称
		- block系列属性：违背规则
		- fallback系列属性：业务方法内部抛异常
- 持久化：借助Nacos配置中心实现